<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intérêts Gagnés - Banque BeLeaza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <a href="/" class="logo">Banque<span>BeLeaza</span></a>
            <nav class="main-nav">
                <ul>
                    <li><a href="/">Accueil</a></li>
                    <li><a href="/login.html">Espace Admin</a></li>
                    <li><a href="/client.html">Espace Client</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mt-5 pt-5">
        <h1 class="mb-4">Rapport des Intérêts Gagnés</h1>

        <div class="section p-3 mb-4 bg-light rounded-3">
            <h2>Filtrer par Période</h2>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label for="date-debut" class="col-form-label">Date de début:</label>
                </div>
                <div class="col-auto">
                    <input type="month" id="date-debut" class="form-control">
                </div>
                <div class="col-auto">
                    <label for="date-fin" class="col-form-label">Date de fin:</label>
                </div>
                <div class="col-auto">
                    <input type="month" id="date-fin" class="form-control">
                </div>
                <div class="col-auto">
                    <button onclick="chargerInterets()" class="btn btn-primary">Filtrer</button>
                </div>
            </div>
        </div>

        <div class="section p-3 mb-4 bg-light rounded-3">
            <h2>Graphique des Intérêts</h2>
            <canvas id="interets-graph"></canvas>
        </div>

        <div class="section p-3 bg-light rounded-3">
            <h2>Tableau des Intérêts</h2>
            <table id="table-interets" class="table table-striped">
                <thead>
                    <tr>
                        <th>Mois</th>
                        <th>Intérêts Gagnés (€)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-cols">
                <div>
                    <h4>À Propos</h4>
                    <p>Votre partenaire financier de confiance.</p>
                </div>
                <div>
                    <h4>Contact</h4>
                    <p>Email: contact@beleaza.com</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 Banque BeLeaza. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiBase = "http://localhost:8000";
        let interetsChart = null;

        function ajax(method, url, data, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, apiBase + url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        callback(JSON.parse(xhr.responseText));
                    } else {
                        alert(`Erreur: ${xhr.responseText}`);
                    }
                }
            };
            xhr.send(JSON.stringify(data));
        }

        function chargerInterets() {
            const dateDebut = document.getElementById('date-debut').value;
            const dateFin = document.getElementById('date-fin').value;

            if (!dateDebut || !dateFin) {
                alert("Veuillez sélectionner une date de début et de fin.");
                return;
            }

            ajax(`GET`, `/interets-gagnes?date_debut=${dateDebut}-01&date_fin=${dateFin}-01`, null, (data) => {
                const tbody = document.querySelector("#table-interets tbody");
                tbody.innerHTML = "";
                data.forEach(item => {
                    tbody.innerHTML += `<tr><td>${item.mois}</td><td>${item.interet.toFixed(2)} €</td></tr>`;
                });
                mettreAJourGraph(data);
            });
        }

        function mettreAJourGraph(data) {
            const ctx = document.getElementById('interets-graph').getContext('2d');
            const labels = data.map(item => item.mois);
            const values = data.map(item => item.interet);

            if (interetsChart) {
                interetsChart.destroy();
            }

            interetsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Intérêts Gagnés par Mois (€)',
                        data: values,
                        backgroundColor: 'rgba(0, 123, 255, 0.5)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(today.getMonth() - 6);

            document.getElementById('date-debut').value = sixMonthsAgo.toISOString().substring(0, 7);
            document.getElementById('date-fin').value = today.toISOString().substring(0, 7);
            
            chargerInterets();
        });
    </script>
</body>
</html>